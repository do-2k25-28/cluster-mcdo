apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: messagerie
  namespace: messagerie
spec:
  interval: 1h
  timeout: 5m
  releaseName: messagerie
  chart:
    spec:
      chart: helm/messagerie
      sourceRef:
        kind: GitRepository
        name: messagerie
        namespace: messagerie
      interval: 5m
  values:
    imagePullSecrets:
      - name: gitlab-registry
    image:
      repository: gitlab.polytech.umontpellier.fr:5050/dev-web/messagerie-instantane
      tag: latest # {"$imagepolicy": "messagerie:messagerie"}
      pullPolicy: IfNotPresent
    service:
      type: ClusterIP
      apiPort: 3000
      frontPort: 8081
    env:
      apiPort: 3000
      frontPort: 8081
      frontOrigin: https://messagerie.polydo.dev
      frontOrigins: https://messagerie.polydo.dev
      database:
        user: messagerie_app
        name: instant_mess
      extraEnv:
        - name: COOKIE_SECURE
          value: "true"
        - name: COOKIE_SAMESITE
          value: "None"
        - name: COOKIE_DOMAIN
          value: ".polydo.dev"
    secrets:
      create: false
      existingSecret: messagerie-secrets
    postgresql:
      enabled: true
      auth:
        username: messagerie_app
        database: instant_mess
        existingSecret: messagerie-secrets
        secretKeys:
          adminPasswordKey: POSTGRES_PASSWORD
          userPasswordKey: DATABASE_PASSWORD
      primary:
        persistence:
          size: 20Gi
    ingress:
      enabled: true
      className: traefik
      annotations:
        traefik.ingress.kubernetes.io/router.entrypoints: websecure
      tls:
        - secretName: cloudflare-origin-cert
          hosts:
            - messagerie.polydo.dev
            - api-messagerie.polydo.dev
      frontend:
        host: messagerie.polydo.dev
        path: /
      api:
        host: api-messagerie.polydo.dev
        path: /
